<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ReelQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05060a;
      --bg-elevated: #111827;
      --bg-soft: #151925;
      --accent: #f9fafb;
      --accent-subtle: #e5e7eb;
      --accent-pill-bg: #f9fafb;
      --accent-pill-text: #111827;
      --border-subtle: #1f2937;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --text-softer: #6b7280;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: #020617;
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: #020617;
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Top bar */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 28px;
      height: 28px;
      border-radius: 9px;
      border: 2px solid var(--accent-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brand-mark-inner {
      width: 16px;
      height: 16px;
      border-radius: 5px;
      background: var(--accent-subtle);
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    /* Tabs */

    .tabs {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      align-items: center;
    }

    .tab-btn {
      flex: 0 0 auto;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease,
        box-shadow 0.15s ease, transform 0.08s ease;
    }

    .tab-btn.active {
      background: var(--accent-pill-bg);
      color: var(--accent-pill-text);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.8);
      transform: translateY(-1px);
    }

    .tab-btn-icon {
      margin-left: auto;
      padding: 8px 10px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    /* Section header */

    .section-header {
      margin-top: 10px;
    }

    .section-title {
      font-size: 26px;
      line-height: 1.25;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .section-subtitle {
      margin-top: 4px;
      font-size: 14px;
      color: var(--text-softer);
    }

    /* Search */

    .search-form {
      margin-top: 18px;
    }

    .search-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      padding: 11px 14px 11px 34px;
      font-size: 14px;
      color: var(--text-main);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-input:focus {
      border-color: var(--accent-subtle);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.8);
      background: #020617;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--text-muted);
      pointer-events: none;
    }

    /* Message */

    .message {
      margin-top: 14px;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Grid & cards */

    .grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
    }

    @media (min-width: 768px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }

    .movie-card {
      background: var(--bg-elevated);
      border-radius: 18px;
      padding: 6px 6px 10px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.6);
    }

    .poster-wrapper {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      aspect-ratio: 2 / 3;
    }

    .poster-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .poster-fallback {
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, #1f2937 0, #020617 65%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-muted);
    }

    .rating-pill {
      position: absolute;
      left: 8px;
      top: 8px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      color: #fde68a;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .rating-pill span {
      color: var(--text-main);
    }

    .poster-actions {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 8px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .card-btn {
      border-radius: 999px;
      border: none;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
      transition: background 0.15s ease, transform 0.08s ease,
        box-shadow 0.15s ease, color 0.15s ease, opacity 0.15s ease;
    }

    .card-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.9);
    }

    .card-btn:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
    }

    .card-btn.active {
      background: var(--accent-pill-bg);
      color: var(--accent-pill-text);
    }

    .movie-title-line {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-subline {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Settings */

    .settings-panel {
      margin-top: 18px;
      padding: 14px 14px 16px;
      border-radius: 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      display: none;
    }

    .settings-heading {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .settings-copy {
      font-size: 13px;
      color: var(--text-softer);
      margin-bottom: 12px;
    }

    .settings-subheading {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-main);
    }

    .genre-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .genre-pill {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 6px 12px;
      font-size: 12px;
      background: #020617;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease,
        border-color 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease;
    }

    .genre-pill.active {
      background: var(--accent-pill-bg);
      color: var(--accent-pill-text);
      border-color: var(--accent-pill-bg);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.75);
      transform: translateY(-1px);
    }

    /* Debug footer (optional, subtle) */
    .debug {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-mark">
          <div class="brand-mark-inner"></div>
        </div>
        <div class="brand-text">ReelQuest</div>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="for-you">For You</button>
      <button class="tab-btn" data-tab="discover">Discover</button>
      <button class="tab-btn" data-tab="watchlist">Watchlist</button>
      <button class="tab-btn" data-tab="watched">Watched</button>
      <button
        class="tab-btn tab-btn-icon"
        data-tab="settings"
        aria-label="Settings"
      >
        ‚öôÔ∏é
      </button>
    </nav>

    <main>
      <section class="section-header">
        <h1 id="section-title" class="section-title">For You</h1>
        <p id="section-subtitle" class="section-subtitle">
          Smart suggestions based on your favourite genres.
        </p>
      </section>

      <form id="search-form" class="search-form" autocomplete="off">
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input
            id="search-input"
            class="search-input"
            type="search"
            placeholder="Search within your recommendations‚Ä¶"
          />
        </div>
      </form>

      <div id="message" class="message">
        Choose a few favourite genres in Settings to see personalised suggestions here.
      </div>

      <div id="settings-panel" class="settings-panel"></div>

      <div id="card-grid" class="grid"></div>

      <div id="debug" class="debug"></div>
    </main>
  </div>

  <script>
    (function () {
      const TMDB_API_KEY = "b24323f85318cb1b12fd1ea0a94420de";

      const GENRES = [
        { id: 28, name: "Action" },
        { id: 12, name: "Adventure" },
        { id: 16, name: "Animation" },
        { id: 35, name: "Comedy" },
        { id: 80, name: "Crime" },
        { id: 99, name: "Documentary" },
        { id: 18, name: "Drama" },
        { id: 10751, name: "Family" },
        { id: 14, name: "Fantasy" },
        { id: 36, name: "History" },
        { id: 27, name: "Horror" },
        { id: 10402, name: "Music" },
        { id: 9648, name: "Mystery" },
        { id: 10749, name: "Romance" },
        { id: 878, name: "Science Fiction" },
        { id: 53, name: "Thriller" },
        { id: 37, name: "Western" }
      ];

      const STORAGE_KEY = "reelquest-state-v5";

      let els = {};

      const state = {
        activeTab: "for-you",
        searchTerm: "",
        tmdbResults: [],
        forYouResults: [],
        forYouLoading: false,
        forYouLoaded: false,
        items: [],
        hasSearchedDiscover: false,
        favouriteGenres: [],
        lastTmdbStatus: ""
      };

      function updateDebug(msg) {
        state.lastTmdbStatus = msg;
        if (els.debug) {
          els.debug.textContent = msg;
        }
      }

      function safeId() {
        if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
        return (
          "m_" +
          Date.now().toString(36) +
          "_" +
          Math.random().toString(16).slice(2)
        );
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed.items)) {
            state.items = parsed.items;
          }
          if (Array.isArray(parsed.favouriteGenres)) {
            state.favouriteGenres = parsed.favouriteGenres;
          }
        } catch (e) {
          console.warn("Failed to load ReelQuest state", e);
        }
      }

      function saveState() {
        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
              items: state.items,
              favouriteGenres: state.favouriteGenres
            })
          );
        } catch (e) {
          console.warn("Failed to save ReelQuest state", e);
        }
      }

      async function tmdbFetch(url) {
        updateDebug("Calling TMDB: " + url.toString());
        const res = await fetch(url.toString(), {
          headers: {
            Accept: "application/json"
          }
        });
        updateDebug("TMDB status: " + res.status);
        if (!res.ok) {
          let text = "";
          try {
            text = await res.text();
          } catch (_) {}
          updateDebug("TMDB error " + res.status + ": " + text);
          throw new Error("TMDB request failed with " + res.status);
        }
        const data = await res.json();
        return data;
      }

      async function searchTmdb(query) {
        if (!TMDB_API_KEY) {
          throw new Error("TMDB API key not set");
        }
        const url = new URL("https://api.themoviedb.org/3/search/movie");
        url.searchParams.set("api_key", TMDB_API_KEY);
        url.searchParams.set("query", query);
        url.searchParams.set("include_adult", "false");
        url.searchParams.set("language", "en-GB");
        url.searchParams.set("page", "1");

        const data = await tmdbFetch(url);
        return Array.isArray(data.results) ? data.results : [];
      }

      async function loadPopularForDiscover() {
        els.message.style.display = "block";
        els.message.textContent = "Loading popular films‚Ä¶";
        els.grid.innerHTML = "";
        try {
          const url = new URL("https://api.themoviedb.org/3/movie/popular");
          url.searchParams.set("api_key", TMDB_API_KEY);
          url.searchParams.set("language", "en-GB");
          url.searchParams.set("page", "1");
          const data = await tmdbFetch(url);
          state.tmdbResults = Array.isArray(data.results)
            ? data.results
            : [];
          state.hasSearchedDiscover = true;
        } catch (err) {
          console.error(err);
          state.tmdbResults = [];
          els.message.textContent =
            "TMDB popular films failed. Please check your API key or network.";
        } finally {
          render();
        }
      }

      async function performDiscoverSearch() {
        const query = state.searchTerm.trim();
        if (!query) {
          // If no query, just show popular list
          if (!state.hasSearchedDiscover) {
            await loadPopularForDiscover();
          } else {
            render();
          }
          return;
        }
        els.message.style.display = "block";
        els.message.textContent = "Searching TMDB‚Ä¶";
        els.grid.innerHTML = "";
        try {
          const results = await searchTmdb(query);
          state.tmdbResults = results;
          state.hasSearchedDiscover = true;
        } catch (err) {
          console.error(err);
          state.tmdbResults = [];
          els.message.textContent =
            "TMDB search failed. Please check your API key or network.";
        } finally {
          render();
        }
      }

      async function loadForYouRecommendations() {
        if (!state.favouriteGenres.length) {
          state.forYouResults = [];
          state.forYouLoaded = false;
          state.forYouLoading = false;
          render();
          return;
        }

        state.forYouLoading = true;
        state.forYouLoaded = false;
        els.message.style.display = "block";
        els.message.textContent =
          "Fetching recommendations based on your favourite genres‚Ä¶";
        els.grid.innerHTML = "";

        const genreCsv = state.favouriteGenres.join(",");

        try {
          const url = new URL("https://api.themoviedb.org/3/discover/movie");
          url.searchParams.set("api_key", TMDB_API_KEY);
          url.searchParams.set("include_adult", "false");
          url.searchParams.set("language", "en-GB");
          url.searchParams.set("sort_by", "popularity.desc");
          url.searchParams.set("with_genres", genreCsv);
          url.searchParams.set("page", "1");

          const data = await tmdbFetch(url);
          state.forYouResults = Array.isArray(data.results)
            ? data.results
            : [];
          state.forYouLoaded = true;
        } catch (err) {
          console.error(err);
          state.forYouResults = [];
          state.forYouLoaded = false;
          els.message.textContent =
            "We couldn‚Äôt load your recommendations. Please check your API key or network.";
        } finally {
          state.forYouLoading = false;
          render();
        }
      }

      function findItemByTmdbId(tmdbId) {
        return state.items.find(function (it) { return it.tmdbId === tmdbId; }) || null;
      }

      function ensureItemFromTmdb(tmdbMovie) {
        let item = findItemByTmdbId(tmdbMovie.id);
        if (item) return item;

        item = {
          id: safeId(),
          tmdbId: tmdbMovie.id,
          title: tmdbMovie.title,
          year: tmdbMovie.release_date
            ? tmdbMovie.release_date.slice(0, 4)
            : "",
          posterPath: tmdbMovie.poster_path || null,
          rating:
            typeof tmdbMovie.vote_average === "number"
              ? tmdbMovie.vote_average
              : null,
          inWatchlist: false,
          watched: false,
          createdAt: Date.now()
        };
        state.items.push(item);
        saveState();
        return item;
      }

      function toggleWatchlistForItem(item) {
        item.inWatchlist = !item.inWatchlist;
        saveState();
        render();
      }

      function toggleWatchedForItem(item) {
        item.watched = !item.watched;
        if (item.watched && !item.inWatchlist) {
          item.inWatchlist = true;
        }
        saveState();
        render();
      }

      function getViewItemsForCurrentTab() {
        const term = state.searchTerm.trim().toLowerCase();

        if (state.activeTab === "discover") {
          let raw = state.tmdbResults || [];
          if (term) {
            raw = raw.filter(function (m) {
              return (m.title || "").toLowerCase().includes(term);
            });
          }
          return raw.map(function (m) {
            const linked = findItemByTmdbId(m.id);
            return { mode: "remote", tmdbMovie: m, item: linked };
          });
        }

        if (state.activeTab === "for-you") {
          let base = state.forYouResults || [];
          if (term) {
            base = base.filter(function (m) {
              return (m.title || "").toLowerCase().includes(term);
            });
          }
          return base.map(function (m) {
            const linked = findItemByTmdbId(m.id);
            return { mode: "remote", tmdbMovie: m, item: linked };
          });
        }

        const base = state.items
          .slice()
          .sort(function (a, b) { return (b.createdAt || 0) - (a.createdAt || 0); })
          .reverse();

        let filtered;
        if (state.activeTab === "watchlist") {
          filtered = base.filter(function (it) { return it.inWatchlist && !it.watched; });
        } else if (state.activeTab === "watched") {
          filtered = base.filter(function (it) { return it.watched; });
        } else {
          filtered = [];
        }

        if (term) {
          filtered = filtered.filter(function (it) {
            return it.title.toLowerCase().includes(term);
          });
        }

        return filtered.map(function (it) {
          return {
            mode: "local",
            item: it,
            tmdbMovie: null
          };
        });
      }

      function toggleFavouriteGenre(id) {
        const idx = state.favouriteGenres.indexOf(id);
        if (idx === -1) {
          state.favouriteGenres.push(id);
        } else {
          state.favouriteGenres.splice(idx, 1);
        }
        saveState();
        renderSettings();
        if (state.activeTab === "for-you") {
          loadForYouRecommendations();
        }
      }

      function renderSettings() {
        const panel = els.settingsPanel;
        panel.innerHTML = "";

        const heading = document.createElement("h2");
        heading.className = "settings-heading";
        heading.textContent = "Preferences";

        const copy = document.createElement("p");
        copy.className = "settings-copy";
        copy.textContent =
          "Tell ReelQuest which genres you love. We‚Äôll use this for smarter suggestions later.";

        const sub = document.createElement("div");
        sub.className = "settings-subheading";
        sub.textContent = "Favourite genres";

        const grid = document.createElement("div");
        grid.className = "genre-grid";

        const selected = new Set(state.favouriteGenres);

        GENRES.forEach(function (genre) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "genre-pill";
          if (selected.has(genre.id)) {
            btn.classList.add("active");
          }
          btn.textContent = genre.name;
          btn.addEventListener("click", function () { toggleFavouriteGenre(genre.id); });
          grid.appendChild(btn);
        });

        panel.appendChild(heading);
        panel.appendChild(copy);
        panel.appendChild(sub);
        panel.appendChild(grid);
      }

      function updateCopyForTab() {
        let title = "";
        let subtitle = "";
        let placeholder = "";

        switch (state.activeTab) {
          case "for-you":
            title = "For You";
            subtitle = "Smart suggestions based on your favourite genres.";
            placeholder = "Search within your recommendations‚Ä¶";
            break;
          case "discover":
            title = "Discover";
            subtitle = "Explore the latest in cinema.";
            placeholder = "Search titles, directors, genres‚Ä¶";
            break;
          case "watchlist":
            title = "Watchlist";
            subtitle = "Films you‚Äôve saved to watch later.";
            placeholder = "Search your watchlist‚Ä¶";
            break;
          case "watched":
            title = "Watched";
            subtitle = "Everything you‚Äôve already seen.";
            placeholder = "Search your watched list‚Ä¶";
            break;
          case "settings":
            title = "Settings";
            subtitle = "Tune ReelQuest to your taste.";
            placeholder = "Search is not used in Settings.";
            break;
        }

        els.sectionTitle.textContent = title;
        els.sectionSubtitle.textContent = subtitle;
        els.searchInput.placeholder = placeholder;
      }

      function getEmptyMessageForTab() {
        if (state.activeTab === "for-you") {
          if (!state.favouriteGenres.length) {
            return "Choose a few favourite genres in Settings to see personalised suggestions here.";
          }
          if (
            state.forYouLoaded &&
            (!state.forYouResults || !state.forYouResults.length)
          ) {
            return "We couldn‚Äôt find any recommendations right now. Try different genres.";
          }
          return "";
        }

        const views = getViewItemsForCurrentTab();
        if (views.length > 0) return "";

        switch (state.activeTab) {
          case "discover":
            return state.hasSearchedDiscover
              ? "No results found. Try another title."
              : "Search TMDB to start discovering films.";
          case "watchlist":
            return "Your watchlist is empty. Tap + on any film to add it.";
          case "watched":
            return "You haven‚Äôt marked anything as watched yet.";
          default:
            return "";
        }
      }

      function createCard(view) {
        const mode = view.mode;
        const item = view.item;
        const tmdbMovie = view.tmdbMovie;
        const isLocal = mode === "local";

        const title = (function () {
          if (isLocal) {
            return item.year ? item.title + " (" + item.year + ")" : item.title;
          }
          if (tmdbMovie && tmdbMovie.release_date) {
            return tmdbMovie.title + " (" + tmdbMovie.release_date.slice(0, 4) + ")";
          }
          return tmdbMovie ? tmdbMovie.title : "";
        })();

        const posterPath = isLocal
          ? item.posterPath
          : tmdbMovie && tmdbMovie.poster_path
          ? tmdbMovie.poster_path
          : null;

        const rating = isLocal
          ? item.rating
          : tmdbMovie && typeof tmdbMovie.vote_average === "number"
          ? tmdbMovie.vote_average
          : null;

        const inWatchlist = isLocal
          ? item.inWatchlist
          : view.item
          ? view.item.inWatchlist
          : false;

        const watched = isLocal
          ? item.watched
          : view.item
          ? view.item.watched
          : false;

        const card = document.createElement("article");
        card.className = "movie-card";

        const posterWrapper = document.createElement("div");
        posterWrapper.className = "poster-wrapper";

        if (posterPath) {
          const img = document.createElement("img");
          img.className = "poster-img";
          img.src = "https://image.tmdb.org/t/p/w342" + posterPath;
          img.alt = title;
          posterWrapper.appendChild(img);
        } else {
          const placeholder = document.createElement("div");
          placeholder.className = "poster-fallback";
          placeholder.textContent = "üé¨";
          posterWrapper.appendChild(placeholder);
        }

        if (rating && !Number.isNaN(rating)) {
          const pill = document.createElement("div");
          pill.className = "rating-pill";
          pill.innerHTML = "‚òÖ <span>" + rating.toFixed(1) + "</span>";
          posterWrapper.appendChild(pill);
        }

        const actions = document.createElement("div");
        actions.className = "poster-actions";

        const eyeBtn = document.createElement("button");
        eyeBtn.type = "button";
        eyeBtn.className =
          "card-btn card-btn-eye" + (watched ? " active" : "");
        eyeBtn.title = watched ? "Mark as not watched" : "Mark as watched";
        eyeBtn.textContent = "üëÅ";

        const plusBtn = document.createElement("button");
        plusBtn.type = "button";
        plusBtn.className =
          "card-btn card-btn-plus" + (inWatchlist ? " active" : "");
        plusBtn.title = inWatchlist
          ? "Remove from watchlist"
          : "Add to watchlist";
        plusBtn.textContent = "+";

        actions.appendChild(eyeBtn);
        actions.appendChild(plusBtn);
        posterWrapper.appendChild(actions);

        const titleLine = document.createElement("div");
        titleLine.className = "movie-title-line";
        titleLine.textContent = title;

        const subline = document.createElement("div");
        subline.className = "movie-subline";
        if (isLocal && item.watched && item.inWatchlist) {
          subline.textContent = "On your watchlist ¬∑ Watched";
        } else if (isLocal && item.watched) {
          subline.textContent = "Watched";
        } else if (isLocal && item.inWatchlist) {
          subline.textContent = "On your watchlist";
        } else if (rating) {
          subline.textContent = "TMDB ¬∑ " + rating.toFixed(1) + "‚òÖ";
        } else {
          subline.textContent = "TMDB";
        }

        card.appendChild(posterWrapper);
        card.appendChild(titleLine);
        card.appendChild(subline);

        eyeBtn.addEventListener("click", function () {
          if (isLocal) {
            toggleWatchedForItem(item);
          } else if (tmdbMovie) {
            const linked = ensureItemFromTmdb(tmdbMovie);
            toggleWatchedForItem(linked);
          }
        });

        plusBtn.addEventListener("click", function () {
          if (isLocal) {
            toggleWatchlistForItem(item);
          } else if (tmdbMovie) {
            const linked = ensureItemFromTmdb(tmdbMovie);
            toggleWatchlistForItem(linked);
          }
        });

        return card;
      }

      function render() {
        updateCopyForTab();

        els.tabButtons.forEach(function (btn) {
          btn.classList.toggle("active", btn.dataset.tab === state.activeTab);
        });

        if (state.activeTab === "settings") {
          els.searchForm.style.display = "none";
          els.message.style.display = "none";
          els.grid.style.display = "none";
          els.settingsPanel.style.display = "block";
          renderSettings();
          return;
        }

        els.searchForm.style.display = "block";
        els.grid.style.display = "grid";
        els.settingsPanel.style.display = "none";

        const views = getViewItemsForCurrentTab();
        els.grid.innerHTML = "";

        const emptyMessage = getEmptyMessageForTab();

        if (state.activeTab === "for-you" && state.forYouLoading) {
          els.message.style.display = "block";
          els.message.textContent =
            "Fetching recommendations based on your favourite genres‚Ä¶";
        } else if (views.length === 0 && emptyMessage) {
          els.message.style.display = "block";
          els.message.textContent = emptyMessage;
        } else if (emptyMessage) {
          els.message.style.display = "block";
          els.message.textContent = emptyMessage;
        } else {
          els.message.style.display = "none";
          els.message.textContent = "";
        }

        views.forEach(function (view) {
          const card = createCard(view);
          els.grid.appendChild(card);
        });

        if (state.lastTmdbStatus) {
          updateDebug(state.lastTmdbStatus);
        }
      }

      function handleTabClick(e) {
        const tab = e.currentTarget.dataset.tab;
        if (!tab || tab === state.activeTab) return;
        state.activeTab = tab;
        state.searchTerm = "";
        els.searchInput.value = "";

        if (tab === "for-you") {
          loadForYouRecommendations();
        } else if (tab === "discover") {
          if (!state.hasSearchedDiscover) {
            loadPopularForDiscover();
          } else {
            render();
          }
        } else {
          render();
        }
      }

      function handleSearchInput(e) {
        state.searchTerm = e.target.value || "";
        if (state.activeTab === "discover") {
          // For Discover, only search on submit (Enter) so we don't hammer the API
          return;
        }
        render();
      }

      function handleSearchSubmit(e) {
        e.preventDefault();
        if (state.activeTab === "discover") {
          performDiscoverSearch();
        } else {
          render();
        }
      }

      function init() {
        els = {
          tabButtons: document.querySelectorAll(".tab-btn"),
          sectionTitle: document.getElementById("section-title"),
          sectionSubtitle: document.getElementById("section-subtitle"),
          searchForm: document.getElementById("search-form"),
          searchInput: document.getElementById("search-input"),
          message: document.getElementById("message"),
          grid: document.getElementById("card-grid"),
          settingsPanel: document.getElementById("settings-panel"),
          debug: document.getElementById("debug")
        };

        loadState();
        render();

        if (state.activeTab === "for-you" && state.favouriteGenres.length) {
          loadForYouRecommendations();
        }

        els.tabButtons.forEach(function (btn) {
          btn.addEventListener("click", handleTabClick);
        });

        els.searchInput.addEventListener("input", handleSearchInput);
        els.searchForm.addEventListener("submit", handleSearchSubmit);
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
