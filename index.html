<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ReelQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Dark theme defaults */
      --bg: #020617;
      --bg-elevated: #111827;
      --bg-soft: #151925;
      --accent-pill-bg: #f9fafb;
      --accent-pill-text: #111827;
      --border-subtle: #1f2937;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --text-softer: #6b7280;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    body.theme-light {
      --bg: #f3f4f6;
      --bg-elevated: #ffffff;
      --bg-soft: #e5e7eb;
      --accent-pill-bg: #111827;
      --accent-pill-text: #f9fafb;
      --border-subtle: #d1d5db;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --text-softer: #9ca3af;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.25);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
      transition: background 0.18s ease, color 0.18s ease;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: var(--bg);
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.5);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: background 0.18s ease, border-color 0.18s ease,
        box-shadow 0.18s ease;
    }

    /* Top bar */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 28px;
      height: 28px;
      border-radius: 9px;
      border: 2px solid var(--accent-pill-bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brand-mark-inner {
      width: 16px;
      height: 16px;
      border-radius: 5px;
      background: var(--accent-pill-bg);
    }

    .brand-text {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      color: var(--text-main);
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      transition: background 0.15s ease, border-color 0.15s ease,
        transform 0.08s ease, box-shadow 0.15s ease;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
    }

    .theme-toggle:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    /* Tabs */

    .tabs {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      align-items: center;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .tab-btn {
      flex: 0 0 auto;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease,
        box-shadow 0.15s ease, transform 0.08s ease;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--accent-pill-bg);
      color: var(--accent-pill-text);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.4);
      transform: translateY(-1px);
    }

    .tab-btn-icon {
      margin-left: auto;
      padding: 8px 10px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    /* Section header */

    .section-header {
      margin-top: 4px;
    }

    .section-title {
      font-size: 26px;
      line-height: 1.25;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .section-subtitle {
      margin-top: 4px;
      font-size: 14px;
      color: var(--text-softer);
    }

    /* Search */

    .search-form {
      margin-top: 14px;
    }

    .search-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      padding: 10px 14px 10px 34px;
      font-size: 14px;
      color: var(--text-main);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-input:focus {
      border-color: var(--accent-pill-bg);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.9);
      background: var(--bg);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--text-muted);
      pointer-events: none;
    }

    /* Controls bar */

    .controls-bar {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    .controls-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .controls-label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .controls-select {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
      color: var(--text-main);
      font-size: 12px;
      padding: 4px 10px;
      outline: none;
    }

    .list-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill-btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
      color: var(--text-main);
      font-size: 11px;
      padding: 5px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, border-color 0.15s ease,
        transform 0.08s ease, box-shadow 0.15s ease;
    }

    .pill-btn:hover {
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
      transform: translateY(-1px);
    }

    .pill-btn:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35);
    }

    /* Message */

    .message {
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-muted);
      min-height: 18px;
    }

    /* Grid & cards */

    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
    }

    @media (min-width: 768px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }

    .movie-card {
      background: var(--bg-elevated);
      border-radius: 18px;
      padding: 6px 6px 10px;
      border: 1px solid rgba(15, 23, 42, 0.4);
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.55);
      cursor: default;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease, background 0.12s ease;
    }

    .movie-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.65);
    }

    .poster-wrapper {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      aspect-ratio: 2 / 3;
      cursor: pointer;
    }

    body.theme-light .poster-wrapper {
      background: #111827;
    }

    .poster-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .poster-fallback {
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, #1f2937 0, #020617 65%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-muted);
    }

    body.theme-light .poster-fallback {
      background: radial-gradient(circle at top, #cbd5f5 0, #020617 65%);
    }

    .rating-pill {
      position: absolute;
      left: 8px;
      top: 8px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      color: #fde68a;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .rating-pill span {
      color: var(--text-main);
    }

    .poster-actions {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 8px;
      display: flex;
      justify-content: center;
      gap: 10px;
      pointer-events: none;
    }

    .card-btn {
      border-radius: 999px;
      border: none;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
      transition: background 0.15s ease, transform 0.08s ease,
        box-shadow 0.15s ease, color 0.15s ease, opacity 0.15s ease;
      pointer-events: auto;
    }

    .card-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.9);
    }

    .card-btn:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
    }

    .card-btn.active {
      background: var(--accent-pill-bg);
      color: var(--accent-pill-text);
    }

    .movie-title-line {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-subline {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Settings */

    .settings-panel {
      margin-top: 18px;
      padding: 14px 14px 16px;
      border-radius: 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      display: none;
    }

    .settings-heading {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .settings-copy {
      font-size: 13px;
      color: var(--text-softer);
      margin-bottom: 12px;
    }

    .settings-subheading {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-main);
    }

    .genre-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .genre-pill {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 6px 12px;
      font-size: 12px;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease,
        border-color 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease;
    }

    .genre-pill.active {
      background: var(--accent-pill-bg);
      color: var(--accent-pill-text);
      border-color: var(--accent-pill-bg);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.6);
      transform: translateY(-1px);
    }

    /* Detail overlay */

    .detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 40;
      backdrop-filter: blur(4px);
    }

    .detail-overlay.hidden {
      display: none;
    }

    .detail-panel {
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      background: var(--bg-elevated);
      border-radius: 24px;
      padding: 16px 16px 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
    }

    .detail-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-title {
      font-size: 18px;
      font-weight: 600;
    }

    .detail-meta {
      font-size: 12px;
      color: var(--text-softer);
    }

    .detail-close {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .detail-body {
      display: flex;
      gap: 12px;
      margin-top: 6px;
      overflow-y: auto;
    }

    .detail-poster {
      flex: 0 0 120px;
      border-radius: 12px;
      overflow: hidden;
      background: #020617;
    }

    body.theme-light .detail-poster {
      background: #111827;
    }

    .detail-poster img {
      width: 100%;
      height: auto;
      display: block;
    }

    .detail-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }

    .detail-overview {
      color: var(--text-main);
      line-height: 1.4;
    }

    .detail-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .detail-chip {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 3px 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .detail-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .detail-link {
      font-size: 12px;
      color: #60a5fa;
      text-decoration: none;
    }

    .detail-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 640px) {
      .detail-body {
        flex-direction: column;
      }
      .detail-poster {
        flex: 0 0 auto;
        align-self: flex-start;
      }
    }

    /* Debug footer */

    .debug {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
      min-height: 14px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-mark">
          <div class="brand-mark-inner"></div>
        </div>
        <div class="brand-text">ReelQuest</div>
      </div>
      <div class="topbar-actions">
        <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle theme">
          ‚òæ
        </button>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="for-you">For You</button>
      <button class="tab-btn" data-tab="discover">Discover</button>
      <button class="tab-btn" data-tab="watchlist">Watchlist</button>
      <button class="tab-btn" data-tab="watched">Watched</button>
      <button
        class="tab-btn tab-btn-icon"
        data-tab="settings"
        aria-label="Settings"
      >
        ‚öôÔ∏é
      </button>
    </nav>

    <main>
      <section class="section-header">
        <h1 id="section-title" class="section-title">For You</h1>
        <p id="section-subtitle" class="section-subtitle">
          Smart suggestions based on your favourite genres.
        </p>
      </section>

      <form id="search-form" class="search-form" autocomplete="off">
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input
            id="search-input"
            class="search-input"
            type="search"
            placeholder="Search within your recommendations‚Ä¶"
          />
        </div>
      </form>

      <div class="controls-bar" id="controls-bar">
        <div class="controls-group">
          <label class="controls-label">
            <span>Sort by</span>
            <select id="sort-select" class="controls-select">
              <option value="default">Default</option>
              <option value="title-asc">Title (A‚ÄìZ)</option>
              <option value="year-desc">Year (newest)</option>
              <option value="rating-desc">Rating (highest)</option>
              <option value="popularity-desc">Popularity</option>
            </select>
          </label>
          <label class="controls-label">
            <span>Min rating</span>
            <select id="rating-filter-select" class="controls-select">
              <option value="0">Any</option>
              <option value="5">5.0+</option>
              <option value="7">7.0+</option>
              <option value="8">8.0+</option>
            </select>
          </label>
        </div>
        <div class="list-actions" id="list-actions"></div>
      </div>

      <div id="message" class="message">
        Choose a few favourite genres in Settings to see personalised suggestions here.
      </div>

      <div id="settings-panel" class="settings-panel"></div>

      <div id="card-grid" class="grid"></div>

      <div id="debug" class="debug"></div>
    </main>
  </div>

  <!-- Detail overlay -->
  <div id="detail-overlay" class="detail-overlay hidden" aria-hidden="true">
    <div class="detail-panel" role="dialog" aria-modal="true">
      <div class="detail-header">
        <div class="detail-title-block">
          <div id="detail-title" class="detail-title"></div>
          <div id="detail-meta" class="detail-meta"></div>
        </div>
        <button id="detail-close" class="detail-close" type="button" aria-label="Close">
          √ó
        </button>
      </div>
      <div class="detail-body">
        <div class="detail-poster" id="detail-poster"></div>
        <div class="detail-main">
          <div id="detail-overview" class="detail-overview"></div>
          <div id="detail-chips" class="detail-chips"></div>
          <div id="detail-actions" class="detail-actions"></div>
          <div id="detail-links"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const TMDB_API_KEY = "b24323f85318cb1b12fd1ea0a94420de";

      const GENRES = [
        { id: 28, name: "Action" },
        { id: 12, name: "Adventure" },
        { id: 16, name: "Animation" },
        { id: 35, name: "Comedy" },
        { id: 80, name: "Crime" },
        { id: 99, name: "Documentary" },
        { id: 18, name: "Drama" },
        { id: 10751, name: "Family" },
        { id: 14, name: "Fantasy" },
        { id: 36, name: "History" },
        { id: 27, name: "Horror" },
        { id: 10402, name: "Music" },
        { id: 9648, name: "Mystery" },
        { id: 10749, name: "Romance" },
        { id: 878, name: "Science Fiction" },
        { id: 53, name: "Thriller" },
        { id: 37, name: "Western" }
      ];

      const STORAGE_KEY = "reelquest-state-v6";

      let els = {};

      const state = {
        activeTab: "for-you",
        searchTerm: "",
        tmdbResults: [],
        forYouResults: [],
        forYouLoading: false,
        forYouLoaded: false,
        items: [],
        hasSearchedDiscover: false,
        favouriteGenres: [],
        lastTmdbStatus: "",
        sortBy: "default",
        minRating: 0,
        theme: "dark",
        detailsCache: {}
      };

      function updateDebug(msg) {
        state.lastTmdbStatus = msg;
        if (els.debug) {
          els.debug.textContent = msg;
        }
      }

      function safeId() {
        if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
        return (
          "m_" +
          Date.now().toString(36) +
          "_" +
          Math.random().toString(16).slice(2)
        );
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed.items)) {
            state.items = parsed.items;
          }
          if (Array.isArray(parsed.favouriteGenres)) {
            state.favouriteGenres = parsed.favouriteGenres;
          }
          if (parsed.sortBy) state.sortBy = parsed.sortBy;
          if (typeof parsed.minRating === "number") {
            state.minRating = parsed.minRating;
          }
          if (parsed.theme === "light" || parsed.theme === "dark") {
            state.theme = parsed.theme;
          }
        } catch (e) {
          console.warn("Failed to load ReelQuest state", e);
        }
      }

      function saveState() {
        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
              items: state.items,
              favouriteGenres: state.favouriteGenres,
              sortBy: state.sortBy,
              minRating: state.minRating,
              theme: state.theme
            })
          );
        } catch (e) {
          console.warn("Failed to save ReelQuest state", e);
        }
      }

      function applyTheme() {
        if (state.theme === "light") {
          document.body.classList.add("theme-light");
          if (els.themeToggle) els.themeToggle.textContent = "‚òÄÔ∏é";
        } else {
          document.body.classList.remove("theme-light");
          if (els.themeToggle) els.themeToggle.textContent = "‚òæ";
        }
      }

      function toggleTheme() {
        state.theme = state.theme === "dark" ? "light" : "dark";
        applyTheme();
        saveState();
      }

      async function tmdbFetch(url) {
        updateDebug("Calling TMDB: " + url.toString());
        const res = await fetch(url.toString(), {
          headers: {
            Accept: "application/json"
          }
        });
        updateDebug("TMDB status: " + res.status);
        if (!res.ok) {
          let text = "";
          try {
            text = await res.text();
          } catch (_) {}
          updateDebug("TMDB error " + res.status + ": " + text);
          throw new Error("TMDB request failed with " + res.status);
        }
        const data = await res.json();
        return data;
      }

      async function searchTmdb(query) {
        if (!TMDB_API_KEY) {
          throw new Error("TMDB API key not set");
        }
        const url = new URL("https://api.themoviedb.org/3/search/movie");
        url.searchParams.set("api_key", TMDB_API_KEY);
        url.searchParams.set("query", query);
        url.searchParams.set("include_adult", "false");
        url.searchParams.set("language", "en-GB");
        url.searchParams.set("page", "1");

        const data = await tmdbFetch(url);
        return Array.isArray(data.results) ? data.results : [];
      }

      async function loadPopularForDiscover() {
        els.message.style.display = "block";
        els.message.textContent = "Loading popular films‚Ä¶";
        els.grid.innerHTML = "";
        try {
          const url = new URL("https://api.themoviedb.org/3/movie/popular");
          url.searchParams.set("api_key", TMDB_API_KEY);
          url.searchParams.set("language", "en-GB");
          url.searchParams.set("page", "1");
          const data = await tmdbFetch(url);
          state.tmdbResults = Array.isArray(data.results)
            ? data.results
            : [];
          state.hasSearchedDiscover = true;
        } catch (err) {
          console.error(err);
          state.tmdbResults = [];
          els.message.textContent =
            "TMDB popular films failed. Please check your connection.";
        } finally {
          render();
        }
      }

      async function performDiscoverSearch() {
        const query = state.searchTerm.trim();
        if (!query) {
          if (!state.hasSearchedDiscover) {
            await loadPopularForDiscover();
          } else {
            render();
          }
          return;
        }
        els.message.style.display = "block";
        els.message.textContent = "Searching TMDB‚Ä¶";
        els.grid.innerHTML = "";
        try {
          const results = await searchTmdb(query);
          state.tmdbResults = results;
          state.hasSearchedDiscover = true;
        } catch (err) {
          console.error(err);
          state.tmdbResults = [];
          els.message.textContent =
            "TMDB search failed. Please check your connection.";
        } finally {
          render();
        }
      }

      async function loadForYouRecommendations() {
        if (!state.favouriteGenres.length) {
          state.forYouResults = [];
          state.forYouLoaded = false;
          state.forYouLoading = false;
          render();
          return;
        }

        state.forYouLoading = true;
        state.forYouLoaded = false;
        els.message.style.display = "block";
        els.message.textContent =
          "Fetching recommendations based on your favourite genres‚Ä¶";
        els.grid.innerHTML = "";

        const genreCsv = state.favouriteGenres.join(",");

        try {
          const url = new URL("https://api.themoviedb.org/3/discover/movie");
          url.searchParams.set("api_key", TMDB_API_KEY);
          url.searchParams.set("include_adult", "false");
          url.searchParams.set("language", "en-GB");
          url.searchParams.set("sort_by", "popularity.desc");
          url.searchParams.set("with_genres", genreCsv);
          url.searchParams.set("page", "1");

          const data = await tmdbFetch(url);
          state.forYouResults = Array.isArray(data.results)
            ? data.results
            : [];
          state.forYouLoaded = true;
        } catch (err) {
          console.error(err);
          state.forYouResults = [];
          state.forYouLoaded = false;
          els.message.textContent =
            "We couldn‚Äôt load your recommendations. Please check your connection.";
        } finally {
          state.forYouLoading = false;
          render();
        }
      }

      function findItemByTmdbId(tmdbId) {
        return state.items.find(function (it) { return it.tmdbId === tmdbId; }) || null;
      }

      function ensureItemFromTmdb(tmdbMovie) {
        let item = findItemByTmdbId(tmdbMovie.id);
        if (item) return item;

        item = {
          id: safeId(),
          tmdbId: tmdbMovie.id,
          title: tmdbMovie.title,
          year: tmdbMovie.release_date
            ? tmdbMovie.release_date.slice(0, 4)
            : "",
          posterPath: tmdbMovie.poster_path || null,
          rating:
            typeof tmdbMovie.vote_average === "number"
              ? tmdbMovie.vote_average
              : null,
          inWatchlist: false,
          watched: false,
          createdAt: Date.now()
        };
        state.items.push(item);
        saveState();
        return item;
      }

      function toggleWatchlistForItem(item) {
        item.inWatchlist = !item.inWatchlist;
        saveState();
        render();
      }

      function toggleWatchedForItem(item) {
        item.watched = !item.watched;
        if (item.watched && !item.inWatchlist) {
          item.inWatchlist = true;
        }
        saveState();
        render();
      }

      function clearWatchlist() {
        if (!window.confirm("Clear your watchlist? This will keep your watched history.")) {
          return;
        }
        state.items.forEach(function (it) {
          if (it.inWatchlist) {
            it.inWatchlist = false;
          }
        });
        saveState();
        render();
      }

      function clearWatched() {
        if (!window.confirm("Clear everything marked as watched?")) {
          return;
        }
        state.items.forEach(function (it) {
          if (it.watched) {
            it.watched = false;
          }
        });
        saveState();
        render();
      }

      function shareWatchlist() {
        const watchlist = state.items
          .slice()
          .filter(function (it) { return it.inWatchlist; })
          .sort(function (a, b) {
            return (a.title || "").localeCompare(b.title || "");
          });

        if (!watchlist.length) {
          window.alert("Your watchlist is empty.");
          return;
        }

        const lines = watchlist.map(function (it, idx) {
          const n = idx + 1;
          const title = it.title || "Untitled";
          const year = it.year ? " (" + it.year + ")" : "";
          const watched = it.watched ? " ¬∑ watched" : "";
          return n + ". " + title + year + watched;
        });

        const text =
          "My ReelQuest watchlist:

" +
          lines.join("
") +
          "

Shared from ReelQuest.";

        if (navigator.share) {
          navigator
            .share({
              title: "My ReelQuest watchlist",
              text
            })
            .catch(function () {});
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(text)
            .then(function () {
              window.alert("Watchlist copied to the clipboard.");
            })
            .catch(function () {
              window.alert("Couldn‚Äôt access the clipboard, but here‚Äôs your list:

" + text);
            });
        } else {
          window.alert(text);
        }
      }

      function ratingFromView(view) {
        if (view.mode === "local") {
          return typeof view.item.rating === "number" ? view.item.rating : 0;
        }
        if (view.tmdbMovie && typeof view.tmdbMovie.vote_average === "number") {
          return view.tmdbMovie.vote_average;
        }
        return 0;
      }

      function yearFromView(view) {
        if (view.mode === "local") {
          return view.item.year ? parseInt(view.item.year, 10) || 0 : 0;
        }
        if (view.tmdbMovie && view.tmdbMovie.release_date) {
          return parseInt(view.tmdbMovie.release_date.slice(0, 4), 10) || 0;
        }
        return 0;
      }

      function popularityFromView(view) {
        if (view.tmdbMovie && typeof view.tmdbMovie.popularity === "number") {
          return view.tmdbMovie.popularity;
        }
        return view.item && view.item.createdAt ? view.item.createdAt : 0;
      }

      function titleFromView(view) {
        if (view.mode === "local") return (view.item.title || "").toLowerCase();
        if (view.tmdbMovie) return (view.tmdbMovie.title || "").toLowerCase();
        return "";
      }

      function applyFiltersAndSort(views) {
        const min = state.minRating || 0;
        let filtered = views;

        if (min > 0) {
          filtered = filtered.filter(function (v) {
            return ratingFromView(v) >= min;
          });
        }

        if (state.sortBy === "default") {
          return filtered;
        }

        const sorted = filtered.slice();

        switch (state.sortBy) {
          case "title-asc":
            sorted.sort(function (a, b) {
              return titleFromView(a).localeCompare(titleFromView(b));
            });
            break;
          case "year-desc":
            sorted.sort(function (a, b) {
              return yearFromView(b) - yearFromView(a);
            });
            break;
          case "rating-desc":
            sorted.sort(function (a, b) {
              return ratingFromView(b) - ratingFromView(a);
            });
            break;
          case "popularity-desc":
            sorted.sort(function (a, b) {
              return popularityFromView(b) - popularityFromView(a);
            });
            break;
        }

        return sorted;
      }

      function getViewItemsForCurrentTab() {
        const term = state.searchTerm.trim().toLowerCase();

        if (state.activeTab === "discover") {
          let raw = state.tmdbResults || [];
          if (term) {
            raw = raw.filter(function (m) {
              return (m.title || "").toLowerCase().includes(term);
            });
          }
          const views = raw.map(function (m) {
            const linked = findItemByTmdbId(m.id);
            return { mode: "remote", tmdbMovie: m, item: linked };
          });
          return applyFiltersAndSort(views);
        }

        if (state.activeTab === "for-you") {
          let base = state.forYouResults || [];
          if (term) {
            base = base.filter(function (m) {
              return (m.title || "").toLowerCase().includes(term);
            });
          }
          const views = base.map(function (m) {
            const linked = findItemByTmdbId(m.id);
            return { mode: "remote", tmdbMovie: m, item: linked };
          });
          return applyFiltersAndSort(views);
        }

        const base = state.items
          .slice()
          .sort(function (a, b) { return (a.createdAt || 0) - (b.createdAt || 0); })
          .reverse();

        let filtered;
        if (state.activeTab === "watchlist") {
          filtered = base.filter(function (it) { return it.inWatchlist; });
        } else if (state.activeTab === "watched") {
          filtered = base.filter(function (it) { return it.watched; });
        } else {
          filtered = [];
        }

        if (term) {
          filtered = filtered.filter(function (it) {
            return (it.title || "").toLowerCase().includes(term);
          });
        }

        const views = filtered.map(function (it) {
          return {
            mode: "local",
            item: it,
            tmdbMovie: null
          };
        });

        return applyFiltersAndSort(views);
      }

      function toggleFavouriteGenre(id) {
        const idx = state.favouriteGenres.indexOf(id);
        if (idx === -1) {
          state.favouriteGenres.push(id);
        } else {
          state.favouriteGenres.splice(idx, 1);
        }
        saveState();
        renderSettings();
        if (state.activeTab === "for-you") {
          loadForYouRecommendations();
        }
      }

      function renderSettings() {
        const panel = els.settingsPanel;
        panel.innerHTML = "";

        const heading = document.createElement("h2");
        heading.className = "settings-heading";
        heading.textContent = "Preferences";

        const copy = document.createElement("p");
        copy.className = "settings-copy";
        copy.textContent =
          "Tell ReelQuest which genres you love. We‚Äôll use this for smarter suggestions later.";

        const sub = document.createElement("div");
        sub.className = "settings-subheading";
        sub.textContent = "Favourite genres";

        const grid = document.createElement("div");
        grid.className = "genre-grid";

        const selected = new Set(state.favouriteGenres);

        GENRES.forEach(function (genre) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "genre-pill";
          if (selected.has(genre.id)) {
            btn.classList.add("active");
          }
          btn.textContent = genre.name;
          btn.addEventListener("click", function () { toggleFavouriteGenre(genre.id); });
          grid.appendChild(btn);
        });

        panel.appendChild(heading);
        panel.appendChild(copy);
        panel.appendChild(sub);
        panel.appendChild(grid);
      }

      function updateCopyForTab() {
        let title = "";
        let subtitle = "";
        let placeholder = "";

        switch (state.activeTab) {
          case "for-you":
            title = "For You";
            subtitle = "Smart suggestions based on your favourite genres.";
            placeholder = "Search within your recommendations‚Ä¶";
            break;
          case "discover":
            title = "Discover";
            subtitle = "Explore the latest in cinema.";
            placeholder = "Search titles, directors, genres‚Ä¶";
            break;
          case "watchlist":
            title = "Watchlist";
            subtitle = "Films you‚Äôve saved to watch later.";
            placeholder = "Search your watchlist‚Ä¶";
            break;
          case "watched":
            title = "Watched";
            subtitle = "Everything you‚Äôve already seen.";
            placeholder = "Search your watched list‚Ä¶";
            break;
          case "settings":
            title = "Settings";
            subtitle = "Tune ReelQuest to your taste.";
            placeholder = "Search is not used in Settings.";
            break;
        }

        els.sectionTitle.textContent = title;
        els.sectionSubtitle.textContent = subtitle;
        els.searchInput.placeholder = placeholder;
      }

      function getEmptyMessageForTab() {
        if (state.activeTab === "for-you") {
          if (!state.favouriteGenres.length) {
            return "Choose a few favourite genres in Settings to see personalised suggestions here.";
          }
          if (
            state.forYouLoaded &&
            (!state.forYouResults || !state.forYouResults.length)
          ) {
            return "We couldn‚Äôt find any recommendations right now. Try different genres.";
          }
          return "";
        }

        const views = getViewItemsForCurrentTab();
        if (views.length > 0) return "";

        switch (state.activeTab) {
          case "discover":
            return state.hasSearchedDiscover
              ? "No results found. Try another title."
              : "Search TMDB to start discovering films.";
          case "watchlist":
            return "Your watchlist is empty. Tap + on any film to add it.";
          case "watched":
            return "You haven‚Äôt marked anything as watched yet.";
          default:
            return "";
        }
      }

      function createCard(view) {
        const mode = view.mode;
        const item = view.item;
        const tmdbMovie = view.tmdbMovie;
        const isLocal = mode === "local";

        const title = (function () {
          if (isLocal) {
            return item.year ? item.title + " (" + item.year + ")" : item.title;
          }
          if (tmdbMovie && tmdbMovie.release_date) {
            return tmdbMovie.title + " (" + tmdbMovie.release_date.slice(0, 4) + ")";
          }
          return tmdbMovie ? tmdbMovie.title : "";
        })();

        const posterPath = isLocal
          ? item.posterPath
          : tmdbMovie && tmdbMovie.poster_path
          ? tmdbMovie.poster_path
          : null;

        const rating = ratingFromView(view);

        const inWatchlist = isLocal
          ? item.inWatchlist
          : view.item
          ? view.item.inWatchlist
          : false;

        const watched = isLocal
          ? item.watched
          : view.item
          ? view.item.watched
          : false;

        const card = document.createElement("article");
        card.className = "movie-card";

        const posterWrapper = document.createElement("div");
        posterWrapper.className = "poster-wrapper";

        if (posterPath) {
          const img = document.createElement("img");
          img.className = "poster-img";
          img.src = "https://image.tmdb.org/t/p/w342" + posterPath;
          img.alt = title;
          posterWrapper.appendChild(img);
        } else {
          const placeholder = document.createElement("div");
          placeholder.className = "poster-fallback";
          placeholder.textContent = "üé¨";
          posterWrapper.appendChild(placeholder);
        }

        if (rating && !Number.isNaN(rating)) {
          const pill = document.createElement("div");
          pill.className = "rating-pill";
          pill.innerHTML = "‚òÖ <span>" + rating.toFixed(1) + "</span>";
          posterWrapper.appendChild(pill);
        }

        const actions = document.createElement("div");
        actions.className = "poster-actions";

        const eyeBtn = document.createElement("button");
        eyeBtn.type = "button";
        eyeBtn.className =
          "card-btn card-btn-eye" + (watched ? " active" : "");
        eyeBtn.title = watched ? "Mark as not watched" : "Mark as watched";
        eyeBtn.textContent = "üëÅ";

        const plusBtn = document.createElement("button");
        plusBtn.type = "button";
        plusBtn.className =
          "card-btn card-btn-plus" + (inWatchlist ? " active" : "");
        plusBtn.title = inWatchlist
          ? "Remove from watchlist"
          : "Add to watchlist";
        plusBtn.textContent = "+";

        actions.appendChild(eyeBtn);
        actions.appendChild(plusBtn);
        posterWrapper.appendChild(actions);

        const titleLine = document.createElement("div");
        titleLine.className = "movie-title-line";
        titleLine.textContent = title;

        const subline = document.createElement("div");
        subline.className = "movie-subline";
        if (isLocal && item.watched && item.inWatchlist) {
          subline.textContent = "On your watchlist ¬∑ Watched";
        } else if (isLocal && item.watched) {
          subline.textContent = "Watched";
        } else if (isLocal && item.inWatchlist) {
          subline.textContent = "On your watchlist";
        } else if (rating) {
          subline.textContent = "TMDB ¬∑ " + rating.toFixed(1) + "‚òÖ";
        } else {
          subline.textContent = "TMDB";
        }

        card.appendChild(posterWrapper);
        card.appendChild(titleLine);
        card.appendChild(subline);

        posterWrapper.addEventListener("click", function () {
          openDetailForView(view);
        });

        eyeBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          if (isLocal) {
            toggleWatchedForItem(item);
          } else if (tmdbMovie) {
            const linked = ensureItemFromTmdb(tmdbMovie);
            toggleWatchedForItem(linked);
          }
        });

        plusBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          if (isLocal) {
            toggleWatchlistForItem(item);
          } else if (tmdbMovie) {
            const linked = ensureItemFromTmdb(tmdbMovie);
            toggleWatchlistForItem(linked);
          }
        });

        return card;
      }

      function renderListActions() {
        const container = els.listActions;
        container.innerHTML = "";

        if (state.activeTab === "watchlist") {
          const clearBtn = document.createElement("button");
          clearBtn.type = "button";
          clearBtn.className = "pill-btn";
          clearBtn.textContent = "Clear watchlist";
          clearBtn.addEventListener("click", clearWatchlist);
          container.appendChild(clearBtn);

          const shareBtn = document.createElement("button");
          shareBtn.type = "button";
          shareBtn.className = "pill-btn";
          shareBtn.textContent = "Share watchlist";
          shareBtn.addEventListener("click", shareWatchlist);
          container.appendChild(shareBtn);
        } else if (state.activeTab === "watched") {
          const clearWatchedBtn = document.createElement("button");
          clearWatchedBtn.type = "button";
          clearWatchedBtn.className = "pill-btn";
          clearWatchedBtn.textContent = "Clear watched";
          clearWatchedBtn.addEventListener("click", clearWatched);
          container.appendChild(clearWatchedBtn);
        }
      }

      function render() {
        updateCopyForTab();

        els.tabButtons.forEach(function (btn) {
          btn.classList.toggle("active", btn.dataset.tab === state.activeTab);
        });

        els.sortSelect.value = state.sortBy;
        els.ratingFilterSelect.value = String(state.minRating);

        // Settings vs main views
        if (state.activeTab === "settings") {
          els.searchForm.style.display = "none";
          els.controlsBar.style.display = "none";
          els.message.style.display = "none";
          els.grid.style.display = "none";
          els.settingsPanel.style.display = "block";
          renderSettings();
          renderListActions();
          return;
        }

        els.searchForm.style.display = "block";
        els.controlsBar.style.display = "flex";
        els.grid.style.display = "grid";
        els.settingsPanel.style.display = "none";

        const views = getViewItemsForCurrentTab();
        els.grid.innerHTML = "";

        const emptyMessage = getEmptyMessageForTab();

        if (state.activeTab === "for-you" && state.forYouLoading) {
          els.message.style.display = "block";
          els.message.textContent =
            "Fetching recommendations based on your favourite genres‚Ä¶";
        } else if (views.length === 0 && emptyMessage) {
          els.message.style.display = "block";
          els.message.textContent = emptyMessage;
        } else if (emptyMessage) {
          els.message.style.display = "block";
          els.message.textContent = emptyMessage;
        } else {
          els.message.style.display = "none";
          els.message.textContent = "";
        }

        views.forEach(function (view) {
          const card = createCard(view);
          els.grid.appendChild(card);
        });

        if (state.lastTmdbStatus) {
          updateDebug(state.lastTmdbStatus);
        }

        renderListActions();
      }

      function handleTabClick(e) {
        const tab = e.currentTarget.dataset.tab;
        if (!tab || tab === state.activeTab) return;
        state.activeTab = tab;
        state.searchTerm = "";
        els.searchInput.value = "";

        if (tab === "for-you") {
          loadForYouRecommendations();
        } else if (tab === "discover") {
          if (!state.hasSearchedDiscover) {
            loadPopularForDiscover();
          } else {
            render();
          }
        } else {
          render();
        }
      }

      function handleSearchInput(e) {
        state.searchTerm = e.target.value || "";
        if (state.activeTab === "discover") {
          return;
        }
        render();
      }

      function handleSearchSubmit(e) {
        e.preventDefault();
        if (state.activeTab === "discover") {
          performDiscoverSearch();
        } else {
          render();
        }
      }

      function handleSortChange(e) {
        state.sortBy = e.target.value || "default";
        saveState();
        render();
      }

      function handleRatingFilterChange(e) {
        const val = parseFloat(e.target.value || "0");
        state.minRating = Number.isNaN(val) ? 0 : val;
        saveState();
        render();
      }

      async function fetchDetails(tmdbId) {
        if (!tmdbId) throw new Error("No TMDB id");
        if (state.detailsCache[tmdbId]) return state.detailsCache[tmdbId];

        const url = new URL("https://api.themoviedb.org/3/movie/" + tmdbId);
        url.searchParams.set("api_key", TMDB_API_KEY);
        url.searchParams.set("language", "en-GB");
        url.searchParams.set("append_to_response", "videos");

        const data = await tmdbFetch(url);
        state.detailsCache[tmdbId] = data;
        return data;
      }

      function closeDetail() {
        els.detailOverlay.classList.add("hidden");
        els.detailOverlay.setAttribute("aria-hidden", "true");
      }

      async function openDetailForView(view) {
        const tmdbId =
          view.mode === "local"
            ? view.item.tmdbId
            : view.tmdbMovie
            ? view.tmdbMovie.id
            : null;

        if (!tmdbId) {
          window.alert("No extra details available for this title.");
          return;
        }

        els.detailTitle.textContent = "Loading‚Ä¶";
        els.detailMeta.textContent = "";
        els.detailPoster.innerHTML = "";
        els.detailOverview.textContent = "";
        els.detailChips.innerHTML = "";
        els.detailActions.innerHTML = "";
        els.detailLinks.innerHTML = "";
        els.detailOverlay.classList.remove("hidden");
        els.detailOverlay.setAttribute("aria-hidden", "false");

        try {
          const details = await fetchDetails(tmdbId);

          const year = details.release_date
            ? details.release_date.slice(0, 4)
            : "";
          const title = (function () {
            if (details.title) return details.title;
            if (view.item && view.item.title) return view.item.title;
            return "Untitled";
          })();
          const runtime = details.runtime ? details.runtime + " min" : "";
          const genresText = (details.genres || [])
            .map(function (g) { return g.name; })
            .join(", ");

          els.detailTitle.textContent = year ? title + " (" + year + ")" : title;

          const metaParts = [];
          if (details.vote_average) {
            metaParts.push("TMDB " + details.vote_average.toFixed(1) + "‚òÖ");
          }
          if (runtime) metaParts.push(runtime);
          if (genresText) metaParts.push(genresText);
          els.detailMeta.textContent = metaParts.join(" ¬∑ ");

          if (details.poster_path) {
            const img = document.createElement("img");
            img.src = "https://image.tmdb.org/t/p/w342" + details.poster_path;
            img.alt = title;
            els.detailPoster.innerHTML = "";
            els.detailPoster.appendChild(img);
          }

          const overview =
            details.overview ||
            (view.tmdbMovie && view.tmdbMovie.overview) ||
            "No synopsis available yet.";
          els.detailOverview.textContent = overview;

          const chips = [];
          if (details.release_date) {
            chips.push("Released " + details.release_date);
          }
          if (details.original_language) {
            chips.push("Original language: " + details.original_language.toUpperCase());
          }
          (details.genres || []).forEach(function (g) {
            chips.push(g.name);
          });

          chips.forEach(function (text) {
            const chip = document.createElement("span");
            chip.className = "detail-chip";
            chip.textContent = text;
            els.detailChips.appendChild(chip);
          });

          // Actions (watchlist / watched)
          const linked =
            view.mode === "local"
              ? view.item
              : ensureItemFromTmdb(details);

          const watchBtn = document.createElement("button");
          watchBtn.type = "button";
          watchBtn.className = "pill-btn";
          watchBtn.textContent = linked.inWatchlist
            ? "Remove from watchlist"
            : "Add to watchlist";
          watchBtn.addEventListener("click", function () {
            toggleWatchlistForItem(linked);
            watchBtn.textContent = linked.inWatchlist
              ? "Remove from watchlist"
              : "Add to watchlist";
          });

          const watchedBtn = document.createElement("button");
          watchedBtn.type = "button";
          watchedBtn.className = "pill-btn";
          watchedBtn.textContent = linked.watched
            ? "Mark as not watched"
            : "Mark as watched";
          watchedBtn.addEventListener("click", function () {
            toggleWatchedForItem(linked);
            watchedBtn.textContent = linked.watched
              ? "Mark as not watched"
              : "Mark as watched";
          });

          els.detailActions.appendChild(watchBtn);
          els.detailActions.appendChild(watchedBtn);

          // Trailer link
          const videos = (details.videos && details.videos.results) || [];
          const trailer = videos.find(function (v) {
            return (
              v.site === "YouTube" &&
              v.type === "Trailer" &&
              v.official
            );
          }) || videos.find(function (v) {
            return v.site === "YouTube" && v.type === "Trailer";
          });

          if (trailer) {
            const link = document.createElement("a");
            link.className = "detail-link";
            link.href = "https://www.youtube.com/watch?v=" + trailer.key;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            link.textContent = "Watch trailer on YouTube";
            els.detailLinks.appendChild(link);
          }

        } catch (err) {
          console.error(err);
          els.detailTitle.textContent = "Couldn‚Äôt load details";
          els.detailOverview.textContent =
            "There was a problem fetching extra information for this film.";
        }
      }

      function init() {
        els = {
          tabButtons: document.querySelectorAll(".tab-btn"),
          sectionTitle: document.getElementById("section-title"),
          sectionSubtitle: document.getElementById("section-subtitle"),
          searchForm: document.getElementById("search-form"),
          searchInput: document.getElementById("search-input"),
          message: document.getElementById("message"),
          grid: document.getElementById("card-grid"),
          settingsPanel: document.getElementById("settings-panel"),
          debug: document.getElementById("debug"),
          controlsBar: document.getElementById("controls-bar"),
          sortSelect: document.getElementById("sort-select"),
          ratingFilterSelect: document.getElementById("rating-filter-select"),
          listActions: document.getElementById("list-actions"),
          detailOverlay: document.getElementById("detail-overlay"),
          detailClose: document.getElementById("detail-close"),
          detailTitle: document.getElementById("detail-title"),
          detailMeta: document.getElementById("detail-meta"),
          detailPoster: document.getElementById("detail-poster"),
          detailOverview: document.getElementById("detail-overview"),
          detailChips: document.getElementById("detail-chips"),
          detailActions: document.getElementById("detail-actions"),
          detailLinks: document.getElementById("detail-links"),
          themeToggle: document.getElementById("theme-toggle")
        };

        loadState();
        applyTheme();
        render();
        updateDebug("ReelQuest ready (JS initialised)");

        if (state.activeTab === "for-you" && state.favouriteGenres.length) {
          loadForYouRecommendations();
        }

        els.tabButtons.forEach(function (btn) {
          btn.addEventListener("click", handleTabClick);
        });

        els.searchInput.addEventListener("input", handleSearchInput);
        els.searchForm.addEventListener("submit", handleSearchSubmit);
        els.sortSelect.addEventListener("change", handleSortChange);
        els.ratingFilterSelect.addEventListener("change", handleRatingFilterChange);

        if (els.themeToggle) {
          els.themeToggle.addEventListener("click", toggleTheme);
        }

        if (els.detailClose) {
          els.detailClose.addEventListener("click", closeDetail);
        }
        if (els.detailOverlay) {
          els.detailOverlay.addEventListener("click", function (e) {
            if (e.target === els.detailOverlay) {
              closeDetail();
            }
          });
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
